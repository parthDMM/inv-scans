<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Counts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <!-- ZXing for barcode scanning -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      touch-action: manipulation;
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
    }

    h1 { margin-bottom: 10px; }

    /* Compact camera window */
    video {
      width: 100%;
      max-width: 420px;
      height: 180px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #ccc;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 6px;
    }

    .start { background: #2563eb; color: white; }
    .stop { background: #ef4444; color: white; }
    .export { background: #16a34a; color: white; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 13px;
    }

    th { background: #f1f5f9; }

    .status { margin-top: 10px; font-size: 14px; }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 340px;
    }

    .modal-box h3 { margin-top: 0; }
    .modal-box label {
      font-size: 13px;
      font-weight: bold;
    }

    .modal-box input,
    .modal-box select {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px;
      font-size: 16px; /* Critical for iOS numeric keypad */
    }

    .quantity-field {
      width: 80%; /* Reduced width */
    }

  </style>
</head>

<body>

<h1>Inventory Counts</h1>
<p>Scan Inventory Barcode, Enter Quantity in inches/sheets, save to Excel.</p>

<button class="start" onclick="startScan()">Start Scan</button>
<button class="stop" onclick="stopScan()">Stop Scan</button>
<button class="export" onclick="exportExcel()">Export Excel</button>
  
<video id="video" autoplay muted></video>

<br><br>

<div class="status" id="status">Status: Idle</div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Barcode</th>
      <th>Quantity</th>
      <th>Unit</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<!-- INPUT MODAL -->
<div class="modal" id="inputModal">
  <div class="modal-box">
    <h3>Enter Details</h3>

    <p><strong>Barcode:</strong> <span id="barcodeText"></span></p>

    <label>Quantity *</label>
    <input id="quantityInput" class="quantity-field" type="number" min="1" placeholder="Enter quantity" inputmode="numeric" pattern="[0-9]*" />

    <label>Unit *</label>
    <select id="unitInput">
      <option value="">Select unit</option>
      <option value="Inch">Inch</option>
      <option value="Sheets">Sheets</option>
    </select>

    <button class="start" onclick="saveEntry()">Save</button>
  </div>
</div>

<script>
  const video = document.getElementById("video");
  const statusEl = document.getElementById("status");
  const tableBody = document.getElementById("tableBody");
  const modal = document.getElementById("inputModal");
  const barcodeText = document.getElementById("barcodeText");
  const quantityInput = document.getElementById("quantityInput");
  const unitInput = document.getElementById("unitInput");

  const codeReader = new ZXing.BrowserMultiFormatReader();
  let scanData = [];
  let scanning = false;
  let currentBarcode = "";

  function startScan() {
    if (scanning) return;
    scanning = true;
    statusEl.textContent = "Status: Scanning...";

    codeReader.decodeFromVideoDevice(null, video, (result, err) => {
      if (result) {
        stopScan();
        currentBarcode = result.text;
        showModal(currentBarcode);
      }
    });
  }

  function stopScan() {
    scanning = false;
    codeReader.reset();
    statusEl.textContent = "Status: Stopped";
  }

  function showModal(code) {
    barcodeText.textContent = code;
    quantityInput.value = "";
    unitInput.value = "";
    modal.style.display = "flex";
    // Focus numeric input to auto open keypad
    quantityInput.focus();
  }

  function saveEntry() {
    const quantity = quantityInput.value.trim();
    const unit = unitInput.value;

    if (!quantity || !unit) {
      alert("Both Quantity and Unit are required");
      return;
    }

    const row = {
      Index: scanData.length + 1,
      Barcode: currentBarcode,
      Quantity: quantity,
      Unit: unit,
      Timestamp: new Date().toLocaleString()
    };

    scanData.push(row);
    appendRow(row);

    modal.style.display = "none";
    startScan(); // resume scanning automatically
  }

  function appendRow(row) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.Index}</td>
      <td>${row.Barcode}</td>
      <td>${row.Quantity}</td>
      <td>${row.Unit}</td>
      <td>${row.Timestamp}</td>
    `;
    tableBody.appendChild(tr);
  }

  function exportExcel() {
    if (scanData.length === 0) {
      alert("No data to export");
      return;
    }

    const ws = XLSX.utils.json_to_sheet(scanData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Scans");

    const fileName = `scans_${new Date().toISOString().split("T")[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
  }
</script>

</body>
</html>
